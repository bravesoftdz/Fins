unit Unit_get_pay;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, DB, OracleData, Grids, DBGridEh, StdCtrls, Mask, DBCtrlsEh,
  wwdbedit, Wwdbigrd, Wwdbgrid, DBSumLst, Buttons, Wwdotdot,
  Wwdbcomb, Oracle, DBLookupEh, Utils, wwcheckbox, Menus, ComCtrls,
  wwdbdatetimepicker;

type
  TForm_get_pay = class(TForm)
    OD_c_kwtp: TOracleDataSet;
    DS_c_kwtp: TDataSource;
    wwDBGrid1: TwwDBGrid;
    GroupBox2: TGroupBox;
    DBSumList1: TDBSumList;
    wwDBGrid1IButton: TwwIButton;
    Button2: TButton;
    Label4: TLabel;
    Edit2: TEdit;
    OD_oper: TOracleDataSet;
    DS_oper: TDataSource;
    Label5: TLabel;
    DBLookupComboboxEh1: TDBLookupComboboxEh;
    OD_mg: TOracleDataSet;
    DS_mg: TDataSource;
    CheckBox1: TCheckBox;
    OD_c_kwtp_mg: TOracleDataSet;
    DS_c_kwtp_mg: TDataSource;
    wwExpandButton1: TwwExpandButton;
    wwDBGrid2: TwwDBGrid;
    OD_c_kwtp_mgLSK: TStringField;
    OD_c_kwtp_mgSUMMA: TFloatField;
    OD_c_kwtp_mgPENYA: TFloatField;
    OD_c_kwtp_mgOPER: TStringField;
    OD_c_kwtp_mgDOPL: TStringField;
    OD_c_kwtp_mgNINK: TFloatField;
    OD_c_kwtp_mgNKOM: TStringField;
    OD_c_kwtp_mgDTEK: TDateTimeField;
    OD_c_kwtp_mgNKVIT: TFloatField;
    DS_typespay: TDataSource;
    OD_typespay: TOracleDataSet;
    OD_typespayID: TFloatField;
    OD_typespayCD: TStringField;
    OD_typespayNAME: TStringField;
    OD_typespayNPP: TFloatField;
    PopupMenu1: TPopupMenu;
    N1: TMenuItem;
    GroupBox1: TGroupBox;
    Label3: TLabel;
    Label2: TLabel;
    Label1: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    wwDBEdit1: TwwDBEdit;
    wwDBEdit2: TwwDBEdit;
    wwDBEdit3: TwwDBEdit;
    Button1: TButton;
    DBLookupComboboxEh2: TDBLookupComboboxEh;
    Edit1: TEdit;
    DBLookupComboboxEh3: TDBLookupComboboxEh;
    Label8: TLabel;
    wwDBEdit4: TwwDBEdit;
    Label9: TLabel;
    wwDBDateTimePicker1: TwwDBDateTimePicker;
    procedure Button1Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure wwDBGrid1UpdateFooter(Sender: TObject);
    procedure wwDBEdit3KeyPress(Sender: TObject; var Key: Char);
    procedure wwDBEdit1KeyPress(Sender: TObject; var Key: Char);
    procedure wwDBEdit2KeyPress(Sender: TObject; var Key: Char);
    procedure FormCreate(Sender: TObject);
    procedure recalcGrid;
    procedure setEnterType(type_: Integer);
    procedure Button2Click(Sender: TObject);
    procedure wwDBEdit3DblClick(Sender: TObject);
    procedure wwDBEdit3KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure CheckBox1Click(Sender: TObject);
    procedure DBLookupComboboxEh2KeyPress(Sender: TObject; var Key: Char);
    procedure OD_operAfterScroll(DataSet: TDataSet);
    procedure DBLookupComboboxEh3CloseUp(Sender: TObject; Accept: Boolean);
    procedure N1Click(Sender: TObject);
  private
    //тип ввода (по адресный или по л.с.)
    enter_type_: Integer;
  public
  end;

var
  Form_get_pay: TForm_get_pay;

implementation

uses DM_module1, Unit_find_adr, Unit_Mainform, Unit_chargepay;

{$R *.dfm}

procedure TForm_get_pay.setEnterType(type_: Integer);
begin
  enter_type_:=type_;
  if enter_type_ =1 then
  begin
  //ввод по-адресный
//  DBComboBoxEh1.ItemIndex:=1;
//  DBComboBoxEh1.Enabled:=false;
  DBLookupComboboxEh2.KeyValue:=null;
  DBLookupComboboxEh2.Enabled:=true;
  end
  else
  begin
//  DBComboBoxEh1.Enabled:=true;
  //ввод по-л/с
  end;

end;

procedure TForm_get_pay.recalcGrid;
begin
  DBSumList1.RecalcAll;
  wwDBGrid1.ColumnByName('Lsk').FooterValue := 'Итого:';
  wwDBGrid1.ColumnByName('Summa').FooterValue :=
    FloatToStr(DBSumList1.SumCollection.Items[0].SumValue);
  wwDBGrid1.ColumnByName('Penya').FooterValue :=
    FloatToStr(DBSumList1.SumCollection.Items[1].SumValue);
end;

procedure TForm_get_pay.Button1Click(Sender: TObject);
var
  summa_: Extended;
  pn_: Extended;
begin

  if wwDBEdit1.Text <> '' then
    summa_:=SuperStrToDouble(wwDBEdit1.Text, 0)
  else
    summa_:=0;

  if wwDBEdit2.Text <> '' then
    pn_:=SuperStrToDouble(wwDBEdit2.Text, 0)
  else
    pn_:=0;

  if (DBLookupComboboxEh2.KeyValue = null)
    and (OD_typespay.FieldByName('CD').AsString='Корректировка') then
  begin
    Application.MessageBox('Не указан период ввода, для корректировки оплаты!','Внимание',
            MB_OK + MB_ICONEXCLAMATION+MB_APPLMODAL);
    Abort;
  end;

  try
  DataModule1.OraclePackage1.CallProcedure
         ('scott.C_GET_PAY.get_payment',
         [null, null, wwDBEdit3.Text, summa_, pn_,
          OD_oper.FieldByName('oper').asString,
          DBLookupComboboxEh2.KeyValue,
           DBLookupComboboxEh3.KeyValue, null, 1,
           wwDBEdit4.Text,
           wwDBDateTimePicker1.DateTime
           ])
  except
   on E:EOracleError do
   begin
    if Pos('C_KWTP_F_KART', E.Message) <> 0 then
     Application.MessageBox('Указанный лицевой счет не существует',
      'Внимание!', MB_ICONSTOP+MB_OK+MB_APPLMODAL)
    else if Pos('C_KWTP_F_OPER', E.Message) <> 0 then
     Application.MessageBox('Указанный код операции не существует',
      'Внимание!', MB_ICONSTOP+MB_OK+MB_APPLMODAL)
    else
     Application.MessageBox(PCHar(E.Message),
      'Внимание!', MB_ICONSTOP+MB_OK+MB_APPLMODAL);
    exit;
   end;
  end;

  if FF('Form_chargepay', 0) = 1 then
     Form_chargepay.recalc;

  OD_c_kwtp.Refresh;
  DBSumList1.RecalcAll;
  recalcGrid;

  OD_c_kwtp.Last;
  DBLookupComboboxEh2.KeyValue:=null;
  wwDBEdit1.Text:='';
  wwDBEdit2.Text:='';
  wwDBEdit3.Text:='';
  wwDBEdit4.Text:='';
  wwDBDateTimePicker1.Text:='';

  wwDBEdit3.SetFocus;

  if enter_type_ = 1 then
  begin
    Application.CreateForm(TForm_find_adr, Form_find_adr);
    Form_find_adr.ShowModal;
    wwDBEdit3.Text := Form_Main.Lsk_;
    Edit1.Text:=DataModule1.OraclePackage1.CallStringFunction(
      'scott.UTILS.GET_ADR_BY_LSK', [Form_Main.Lsk_]);
  end;

end;

procedure TForm_get_pay.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  Action:=caFree;
end;

procedure TForm_get_pay.wwDBGrid1UpdateFooter(Sender: TObject);
begin
  wwDBGrid1.ColumnByName('Lsk').FooterValue := 'Итого:';
  wwDBGrid1.ColumnByName('Summa').FooterValue :=
    FloatToStr(DBSumList1.SumCollection.Items[0].SumValue);
  wwDBGrid1.ColumnByName('Penya').FooterValue :=
    FloatToStr(DBSumList1.SumCollection.Items[1].SumValue);
  wwDBGrid1.CalcCellRow;
end;

procedure TForm_get_pay.wwDBEdit3KeyPress(Sender: TObject; var Key: Char);
var
  formexist_, a: Integer;
begin
  if Key = #13 then
  begin
    wwDBEdit1.SetFocus;
    Edit1.Text:=DataModule1.OraclePackage1.CallStringFunction(
      'scott.UTILS.GET_ADR_BY_LSK', [wwDBEdit3.Text]);
  end;
end;

procedure TForm_get_pay.wwDBEdit1KeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    wwDBEdit2.SetFocus;
  if RetKey(Key) then
    Key:= '.';

end;

procedure TForm_get_pay.wwDBEdit2KeyPress(Sender: TObject; var Key: Char);
begin
  if (Key = #13) and (DBLookupComboboxEh2.Enabled = true) then
    DBLookupComboboxEh2.SetFocus
  else if (Key = #13) and (DBLookupComboboxEh2.Enabled = false) then
    Button1.SetFocus;

  if RetKey(Key) then
    Key:= '.';

end;

procedure TForm_get_pay.FormCreate(Sender: TObject);
begin
  DecimalSeparator:='.';
  TForm(Sender).AutoSize:=true;


  //Включить ли расширенные реквизиты на вводе оплаты
  if DataModule1.OraclePackage1.CallIntegerFunction
       ('scott.Utils.get_int_param', ['EXTENDED_PAY']) = 1 then
  begin
   Label8.Visible:=true;
   Label9.Visible:=true;
   wwDBEdit4.Visible:=true;
   wwDBDateTimePicker1.Visible:=true;
  end
  else
  begin
   Label8.Visible:=false;
   Label9.Visible:=false;
   wwDBEdit4.Visible:=false;
   wwDBDateTimePicker1.Visible:=false;
  end;

  OD_typespay.SearchRecord('CD', 'Обычный платеж', [srFromBeginning]);
  if OD_typespay.FieldByName('CD').AsString <> 'Обычный платеж' then
    begin
      DBLookupComboboxEh2.KeyValue:=null;
      DBLookupComboboxEh2.Enabled:=true;
    end
    else
    begin
      DBLookupComboboxEh2.KeyValue:=null;
      DBLookupComboboxEh2.Enabled:=false;
    end;

  DBLookupComboboxEh3.KeyValue:=OD_typespay.FieldByName('id').AsInteger;

  OD_oper.Active:=true;
  OD_c_kwtp.SetVariable('var', 0); //не проинкасс
  OD_c_kwtp.Refresh;
  DBLookupComboboxEh1.KeyValue:='01';
  Edit2.Text:=DataModule1.OraclePackage1.CallStringFunction(
    'scott.INIT.get_nkom', parNone);
  DBSumList1.RecalcAll;
  recalcGrid;

end;

procedure TForm_get_pay.Button2Click(Sender: TObject);
begin
  Close;
end;

procedure TForm_get_pay.wwDBEdit3DblClick(Sender: TObject);
begin
  Application.CreateForm(TForm_find_adr, Form_find_adr);
  Form_find_adr.ShowModal;
  wwDBEdit3.Text := Form_Main.Lsk_;
  Edit1.Text:=DataModule1.OraclePackage1.CallStringFunction(
    'scott.UTILS.GET_ADR_BY_LSK', [Form_Main.Lsk_]);

end;

procedure TForm_get_pay.wwDBEdit3KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
  formexist_, a: Integer;
begin
  if Key=34 then
  begin
    Application.CreateForm(TForm_find_adr, Form_find_adr);
    Form_find_adr.ShowModal;
    wwDBEdit3.Text := Form_Main.Lsk_;
    Edit1.Text:=DataModule1.OraclePackage1.CallStringFunction(
      'scott.UTILS.GET_ADR_BY_LSK', [Form_Main.Lsk_]);
  end;

end;

procedure TForm_get_pay.CheckBox1Click(Sender: TObject);
begin
  if CheckBox1.Checked then
   OD_c_kwtp.SetVariable('var', 1) //не проинкасс
   else
   OD_c_kwtp.SetVariable('var', 0); //не проинкасс

   OD_c_kwtp.Refresh;
end;

procedure TForm_get_pay.DBLookupComboboxEh2KeyPress(Sender: TObject;
  var Key: Char);
begin
  if Key = #13 then
    Button1.SetFocus;
end;

procedure TForm_get_pay.OD_operAfterScroll(DataSet: TDataSet);
begin
  recalcGrid;
end;

procedure TForm_get_pay.DBLookupComboboxEh3CloseUp(Sender: TObject;
  Accept: Boolean);
begin
  if OD_typespay.FieldByName('CD').AsString <> 'Обычный платеж' then
    begin
      DBLookupComboboxEh2.KeyValue:=null;
      DBLookupComboboxEh2.Enabled:=true;
    end
    else
    begin
      DBLookupComboboxEh2.KeyValue:=null;
      DBLookupComboboxEh2.Enabled:=false;
    end;
end;

procedure TForm_get_pay.N1Click(Sender: TObject);
var
  bm: TBookmark;
begin
if msg3('Удалить оплату с суммой '+OD_c_kwtp.FieldByName('summa').AsString+
   'руб., Л/С '+OD_c_kwtp.FieldByName('lsk').AsString,
   'Внимание!',
   MB_YESNO+MB_ICONQUESTION) = IDYES then
   begin
   DataModule1.OraclePackage1.CallProcedure
       ('scott.C_GET_PAY.remove_pay',
         [OD_c_kwtp.FieldByName('id').AsInteger]);
   OD_c_kwtp.Prior;
   bm:=OD_c_kwtp.GetBookmark;
   OD_c_kwtp.Active:=False;
   OD_c_kwtp.Active:=true;
   try
    OD_c_kwtp.GotoBookmark(bm);
   except
   end;

   msg2('Строка оплаты удалена!',
      'Внимание!',
   MB_OK)
   end;
end;

end.



