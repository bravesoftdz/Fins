unit Unit_changes_houses;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, DB, OracleData, StdCtrls, Oracle,
  wwSpeedButton, wwDBNavigator, ExtCtrls, wwclearpanel, DBGridEh, wwdblook,
  Mask, wwdbedit, Wwdbdlg, Utils, GridsEh, frxClass, frxDBSet;

type
  TForm_changes_houses = class(TForm)
    OD_list_choices_changes: TOracleDataSet;
    DS_list_choices_changes: TDataSource;
    OD_sprorg: TOracleDataSet;
    DS_sprorg: TDataSource;
    OD_usl: TOracleDataSet;
    DS_usl: TDataSource;
    OD_list_choices_changesusl_name: TStringField;
    OD_list_choices_changesUSL_ID: TStringField;
    OD_list_choices_changesORG1_ID: TFloatField;
    OD_list_choices_changesorg_name1: TStringField;
    OD_sprorg2: TOracleDataSet;
    DS_sprorg2: TDataSource;
    OD_list_choices_changesorg_name2: TStringField;
    OD_list_choices_changesORG2_ID: TFloatField;
    OD_list_choices_changesPROC1: TFloatField;
    OD_list_choices_changesPROC2: TFloatField;
    OD_list_choices_changesABS_SET: TFloatField;
    Button2: TButton;
    DBGridEh1: TDBGridEh;
    OD_mg: TOracleDataSet;
    DS_mg: TDataSource;
    GroupBox1: TGroupBox;
    Label1: TLabel;
    wwDBEdit3: TwwDBEdit;
    wwDBEdit1: TwwDBEdit;
    Label2: TLabel;
    wwDBLookupCombo2: TwwDBLookupCombo;
    Label3: TLabel;
    CheckBox1: TCheckBox;
    wwDBNavigator2: TwwDBNavigator;
    wwNavButton1: TwwNavButton;
    wwNavButton2: TwwNavButton;
    wwNavButton3: TwwNavButton;
    wwNavButton4: TwwNavButton;
    wwNavButton5: TwwNavButton;
    wwNavButton6: TwwNavButton;
    wwNavButton7: TwwNavButton;
    wwDBNavigator1Delete: TwwNavButton;
    wwDBNavigator1Edit: TwwNavButton;
    wwDBNavigator1Post: TwwNavButton;
    wwNavButton8: TwwNavButton;
    wwNavButton9: TwwNavButton;
    wwNavButton10: TwwNavButton;
    wwNavButton11: TwwNavButton;
    CheckBox2: TCheckBox;
    Button1: TButton;
    Label4: TLabel;
    wwDBEdit2: TwwDBEdit;
    OD_list_choices_changesTYPE_NAME: TStringField;
    OD_list_choices_changesCNT_DAYS: TFloatField;
    OD_list_choices_changesCNT_DAYS2: TFloatField;
    OD_report: TOracleDataSet;
    DS_report: TDataSource;
    frxDBDataset1: TfrxDBDataset;
    frxReport1: TfrxReport;
    RadioGroup1: TRadioGroup;
    CheckBox3: TCheckBox;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure CheckBox1Click(Sender: TObject);
    procedure DBGridEh1KeyPress(Sender: TObject; var Key: Char);
    procedure CheckBox3Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form_changes_houses: TForm_changes_houses;
  clr_: Integer;

implementation

uses DM_module1, Unit_status, Unit_sel_hs, Unit_list_kart, Unit_chargepay;

{$R *.dfm}

procedure TForm_changes_houses.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  Action:=caFree;
end;

procedure TForm_changes_houses.Button1Click(Sender: TObject);
var
  cnt_, tst_, is_sch_, usl_add_, doc_id_: Integer;
begin
  if not (OD_list_choices_changes.State in [dsBrowse]) then
    OD_list_choices_changes.Post;

  if OD_list_choices_changes.RecordCount = 0 then
  begin
    msg2('Не введены изменения!','Внимание',
            MB_OK + MB_ICONSTOP+MB_APPLMODAL);
    Abort;
  end;

  if wwDBLookupCombo2.Value = '' then
  begin
    msg2('Не указан период изменений!','Внимание',
            MB_OK + MB_ICONSTOP+MB_APPLMODAL);
    Abort;
  end;

  if (not CheckBox1.Checked ) and (wwDBEdit1.Text='') and (wwDBEdit3.Text='') then
  begin
    Application.MessageBox('Не указаны лицевые счета!','Внимание',
            MB_OK + MB_ICONEXCLAMATION+MB_APPLMODAL);
    Abort;
  end;

   if CheckBox2.Checked then
     usl_add_ := 1
   else
     usl_add_ := 0;

   if RadioGroup1.ItemIndex=0 then
     is_sch_ := 0
   else if RadioGroup1.ItemIndex=1 then
     is_sch_ := 1
   else if RadioGroup1.ItemIndex=2 then
     is_sch_ := 2;

  Application.CreateForm(TForm_status, Form_status);
  Form_status.Update;
  //Тестируем
  try
  DataModule1.OraclePackage1.CallProcedure
         ('scott.C_CHANGES.gen_changes_proc',
          [wwDBEdit3.Text, wwDBEdit1.Text,
           OD_mg.FieldByName('mg').asString,
           usl_add_, is_sch_, 1,
           wwDBEdit2.Text, parInteger, parInteger]);
   except
   on E:EOracleError do
   begin
    if Pos('20001', E.Message) <> 0 then
      msg2('Вам запрещено выполнять изменения по Л/С: '+copy(E.Message,12,8),
       'Внимание!',MB_ICONSTOP+MB_OK)
    else
      msg2(E.Message,
       'Внимание!',MB_ICONSTOP+MB_OK);
      Form_status.Close;
      Exit;
   end;
  end;
  cnt_:=DataModule1.OraclePackage1.GetParameter(7);
  doc_id_:=DataModule1.OraclePackage1.GetParameter(8);
  if cnt_ = -2 then
  begin
    if msg3('Период не соответствует периоду действия данных Л/C., продолжить?','Внимание!',
     MB_YESNO) = ID_NO then
     begin
       Form_status.Close;
       exit;
     end;
  end;

  //Выполняем
  try
  DataModule1.OraclePackage1.CallProcedure
         ('scott.C_CHANGES.gen_changes_proc',
          [wwDBEdit3.Text, wwDBEdit1.Text,
           OD_mg.FieldByName('mg').asString,
           usl_add_, is_sch_, 0,
           wwDBEdit2.Text, parInteger, parInteger]);
   except
   on E:EOracleError do
   begin
    if Pos('20001', E.Message) <> 0 then
      msg2('Вам запрещено выполнять изменения по Л/С: '+copy(E.Message,12,8),
       'Внимание!',MB_ICONSTOP+MB_OK)
    else
      msg2(E.Message,
       'Внимание!',MB_ICONSTOP+MB_OK);
      Form_status.Close;
      Exit;
   end;
  end;
  cnt_:=DataModule1.OraclePackage1.GetParameter(7);
  doc_id_:=DataModule1.OraclePackage1.GetParameter(8);
  Form_status.Close;
  msg2('Перерасчет выполнен по '+IntToStr(cnt_)+' Л/C.','Внимание!',
   MB_OK+MB_ICONINFORMATION);
   tst_:=DataModule1.OraclePackage1.CallIntegerFunction
         ('scott.C_CHANGES.test_abs_or_proc',
          [parNone]);

  //чистим поля
  if tst_ = 0 then   //изменения по процентам
  begin
    wwDBEdit1.Text:='';
    wwDBEdit3.Text:='';
  end
  else               //изменения в абс суммах
  begin
    wwDBEdit1.Text:='';
    wwDBEdit3.Text:='';
    DataModule1.OraclePackage1.CallProcedure
           ('scott.C_CHANGES.clear_changes_proc', [parNone]);
  end;

  OD_report.Active:=false;
  OD_report.SetVariable('doc_id_', doc_id_);
  //Выводить детализированный отчет, если записей не много (< 20)
  if cnt_ > 20 then
    OD_report.SetVariable('var_', 0)
  else
    OD_report.SetVariable('var_', 1);
  OD_report.Active:=true;
  frxReport1.PrepareReport(true);
  frxReport1.ShowPreparedReport;
  OD_list_choices_changes.Refresh;
  if FF('Form_chargepay', 0) = 1 then
     Form_chargepay.recalc;
end;

procedure TForm_changes_houses.Button2Click(Sender: TObject);
begin
  Close;
end;

procedure TForm_changes_houses.FormCreate(Sender: TObject);
begin
  OD_mg.Active:=True;
  OD_usl.Active:=True;
  wwDBLookupCombo2.LookUpValue:=OD_mg.FieldByName('period').AsString;

  if FF('Form_list_kart',0) = 1 then
  begin
    wwDBEdit1.Text:=Form_list_kart.OD_list_kart.FieldByName('lsk').AsString;
    wwDBEdit3.Text:=Form_list_kart.OD_list_kart.FieldByName('lsk').AsString;
  end;
  DataModule1.OraclePackage1.CallProcedure
           ('scott.C_CHANGES.clear_changes_proc', [parNone]);
  OD_sprorg.Active:=False;
  OD_sprorg.SetVariable('var_',1);
  OD_sprorg.Active:=True;
  OD_sprorg2.Active:=False;
  OD_sprorg2.SetVariable('var_',1);
  OD_sprorg2.Active:=True;
  OD_list_choices_changes.Refresh;

  TForm(Sender).AutoSize:=true;
  clr_ := 0;
end;

procedure TForm_changes_houses.CheckBox1Click(Sender: TObject);
begin
 if CheckBox1.Checked then
 begin
   wwDBEdit1.Enabled:=false;
   wwDBEdit3.Enabled:=false;
   wwDBEdit1.Text:='';
   wwDBEdit3.Text:='';

   if clr_=0 then
   begin
     Application.CreateForm(TForm_sel_hs, Form_sel_hs);
     Form_sel_hs.OD_list_choice.Active := false;
     Form_sel_hs.OD_list_choice.SetVariable('clr_',1);
     Form_sel_hs.OD_list_choice.Active := true;
//    clr_:=1;  -- нельзя ставить 1, так как после коммита по раз.изменениям, таблица очищается...
   end
   else
   begin
     Application.CreateForm(TForm_sel_hs, Form_sel_hs);
   end;
 end
 else
 begin
   wwDBEdit1.Enabled:=true;
   wwDBEdit3.Enabled:=true;
 end;
end;

procedure TForm_changes_houses.DBGridEh1KeyPress(Sender: TObject;
  var Key: Char);
begin
  if RetKey(Key) then
    Key:= '.';

end;

procedure TForm_changes_houses.CheckBox3Click(Sender: TObject);
begin
  if CheckBox3.checked = True then
  begin
    OD_sprorg.Active:=False;
    OD_sprorg.SetVariable('var_',0);
    OD_sprorg.Active:=True;
    OD_sprorg2.Active:=False;
    OD_sprorg2.SetVariable('var_',0);
    OD_sprorg2.Active:=True;
  end
  else
  begin
    OD_sprorg.Active:=False;
    OD_sprorg.SetVariable('var_',1);
    OD_sprorg.Active:=True;
    OD_sprorg2.Active:=False;
    OD_sprorg2.SetVariable('var_',1);
    OD_sprorg2.Active:=True;
  end;

end;

end.
